<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .course-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .enrolled { background-color: #d4edda; border-color: #c3e6cb; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üéì Course Enrollment Test</h1>
    
    <div class="container">
        <h2>System Status</h2>
        <div id="status" class="status info">Checking system status...</div>
        <button onclick="checkStatus()">Refresh Status</button>
    </div>

    <div class="container">
        <h2>Available Courses</h2>
        <div id="courses">Loading courses...</div>
    </div>

    <div class="container">
        <h2>Enrolled Courses</h2>
        <div id="enrolled">Loading enrolled courses...</div>
        <button onclick="refreshEnrolled()">Refresh Enrolled</button>
    </div>

    <div class="container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const TEST_USER_ID = 'demo_user_default';
        
        let courses = [];
        let enrolledCourses = [];

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = 'Checking...';
            
            try {
                // Test if server is running
                const result = await apiCall('/courses/all');
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ Server is running</div>
                        <div class="info">üìö Found ${result.data.length} courses</div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">‚ùå Server error: ${result.data?.error || 'Unknown error'}</div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">‚ùå Cannot connect to server. Make sure Next.js dev server is running on port 3000.</div>
                `;
            }
        }

        async function loadCourses() {
            const coursesDiv = document.getElementById('courses');
            
            const result = await apiCall('/courses/all');
            
            if (result.success) {
                courses = result.data.slice(0, 3); // Only show first 3 courses
                coursesDiv.innerHTML = courses.map(course => `
                    <div class="course-card" id="course-${course.id}">
                        <h3>${course.course_code}: ${course.title}</h3>
                        <p>Teacher: ${course.teacher_name}</p>
                        <button onclick="enrollInCourse('${course.id}')" id="enroll-btn-${course.id}">
                            Enroll
                        </button>
                        <button onclick="unenrollFromCourse('${course.id}')" id="unenroll-btn-${course.id}">
                            Unenroll
                        </button>
                    </div>
                `).join('');
                updateEnrollmentButtons();
            } else {
                coursesDiv.innerHTML = `<div class="error">Failed to load courses: ${result.error || result.data?.error}</div>`;
            }
        }

        async function loadEnrolled() {
            const enrolledDiv = document.getElementById('enrolled');
            
            const result = await apiCall(`/courses/enrolled?userId=${TEST_USER_ID}`);
            
            if (result.success) {
                enrolledCourses = result.data;
                enrolledDiv.innerHTML = enrolledCourses.length > 0 
                    ? enrolledCourses.map(course => `
                        <div class="course-card enrolled">
                            <h3>${course.course_code}: ${course.title}</h3>
                            <p>Enrolled: ${new Date(course.enrollment?.enrollment_date).toLocaleDateString()}</p>
                            <p>Progress: ${course.enrollment?.progress_percentage || 0}%</p>
                        </div>
                    `).join('')
                    : '<div class="info">No enrolled courses</div>';
                updateEnrollmentButtons();
            } else {
                enrolledDiv.innerHTML = `<div class="error">Failed to load enrolled courses: ${result.error || result.data?.error}</div>`;
            }
        }

        function updateEnrollmentButtons() {
            const enrolledIds = new Set(enrolledCourses.map(c => c.id));
            
            courses.forEach(course => {
                const enrollBtn = document.getElementById(`enroll-btn-${course.id}`);
                const unenrollBtn = document.getElementById(`unenroll-btn-${course.id}`);
                const courseCard = document.getElementById(`course-${course.id}`);
                
                if (enrollBtn && unenrollBtn && courseCard) {
                    const isEnrolled = enrolledIds.has(course.id);
                    
                    enrollBtn.disabled = isEnrolled;
                    unenrollBtn.disabled = !isEnrolled;
                    
                    if (isEnrolled) {
                        courseCard.classList.add('enrolled');
                        enrollBtn.textContent = 'Already Enrolled';
                    } else {
                        courseCard.classList.remove('enrolled');
                        enrollBtn.textContent = 'Enroll';
                    }
                }
            });
        }

        async function enrollInCourse(courseId) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `<div class="info">üîÑ Enrolling in course ${courseId}...</div>`;
            
            const result = await apiCall('/courses/enroll', {
                method: 'POST',
                body: JSON.stringify({ courseId, userId: TEST_USER_ID })
            });
            
            if (result.success) {
                resultsDiv.innerHTML += `<div class="success">‚úÖ Successfully enrolled in course!</div>`;
                await loadEnrolled(); // Refresh enrolled courses
            } else {
                resultsDiv.innerHTML += `<div class="error">‚ùå Enrollment failed: ${result.error || result.data?.error}</div>`;
            }
        }

        async function unenrollFromCourse(courseId) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `<div class="info">üîÑ Unenrolling from course ${courseId}...</div>`;
            
            const result = await apiCall('/courses/unenroll', {
                method: 'DELETE',
                body: JSON.stringify({ courseId, userId: TEST_USER_ID })
            });
            
            if (result.success) {
                resultsDiv.innerHTML += `<div class="success">‚úÖ Successfully unenrolled from course!</div>`;
                await loadEnrolled(); // Refresh enrolled courses
            } else {
                resultsDiv.innerHTML += `<div class="error">‚ùå Unenrollment failed: ${result.error || result.data?.error}</div>`;
            }
        }

        async function refreshEnrolled() {
            await loadEnrolled();
        }

        // Initialize
        window.onload = async function() {
            await checkStatus();
            await loadCourses();
            await loadEnrolled();
        };
    </script>
</body>
</html>
